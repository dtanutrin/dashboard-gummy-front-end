# GUIA DE INTEGRAÃ‡ÃƒO FRONTEND - SISTEMA DE PERMISSÃ•ES GRANULARES

## ğŸš¨ CORREÃ‡Ã•ES URGENTES DE BACKEND

### 1. Middleware de AutenticaÃ§Ã£o
PROBLEMA: Token nÃ£o estÃ¡ sendo reconhecido corretamente

VERIFICAR:
- Middleware `authenticateToken` em `/middleware/authenticateToken.js`
- Header deve ser: `Authorization: Bearer <token>`
- Token deve estar vÃ¡lido e nÃ£o expirado

### 2. Endpoint Dashboard Permissions
PROBLEMA: 403 Forbidden em `/api/dashboard-permissions/user/54`

SOLUÃ‡ÃƒO BACKEND:
- Verificar se middleware `isAdmin` estÃ¡ funcionando
- UsuÃ¡rio com role "User" NÃƒO pode acessar este endpoint
- Apenas usuÃ¡rios com role "Admin" podem gerenciar permissÃµes

### 3. CORS Configuration
VERIFICAR arquivo `/middleware/cors.js`:
```javascript
res.header('Access-Control-Allow-Origin', process.env.FRONTEND_URL || 'http://localhost:3000');
res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');



## ENDPOINTS NECESSÃRIOS PARA O FRONTEND
### AutenticaÃ§Ã£o
```
POSTÂ /api/auth/login
Body:Â {Â email,Â passwordÂ }
Response:Â {Â token,Â user:Â {Â 
id,Â email,Â role,Â areasÂ }Â }
```

### Ãreas (com dashboards filtrados)
```
GETÂ /api/areas
Headers:Â Authorization:Â 
BearerÂ <token>
Response:Â [{Â id,Â name,Â 
dashboards:Â [...]Â }]
```
### Gerenciamento de PermissÃµes (APENAS ADMIN)
```
GETÂ /api/
dashboard-permissions/user/
:userId
Headers:Â Authorization:Â 
BearerÂ <admin_token>
Response:Â [{Â dashboardId,Â 
dashboard:Â {...}Â }]

POSTÂ /api/
dashboard-permissions/grant
Headers:Â Authorization:Â 
BearerÂ <admin_token>
Body:Â {Â userId,Â dashboardIdÂ }

POSTÂ /api/
dashboard-permissions/revoke
Headers:Â Authorization:Â 
BearerÂ <admin_token>
Body:Â {Â userId,Â dashboardIdÂ }
```

### UsuÃ¡rios (APENAS ADMIN)
```
GETÂ /api/users
POSTÂ /api/users
PUTÂ /api/users/:id
DELETEÂ /api/users/:id
```

## CONFIGURAÃ‡Ã•ES FRONTEND NECESSÃRIAS
### 1. Axios Interceptor
```
//Â ConfigurarÂ interceptorÂ 
paraÂ incluirÂ tokenÂ 
automaticamente
axios.interceptors.request.
use(
Â Â (config)Â =>Â {
Â Â Â Â constÂ tokenÂ =Â 
Â Â Â Â localStorage.getItem
Â Â Â Â ('token');
Â Â Â Â ifÂ (token)Â {
Â Â Â Â Â Â config.headers.
Â Â Â Â Â Â AuthorizationÂ =Â 
Â Â Â Â Â Â `BearerÂ ${token}`;
Â Â Â Â }
Â Â Â Â returnÂ config;
Â Â },
Â Â (error)Â =>Â Promise.reject
Â Â (error)
);

//Â InterceptorÂ paraÂ tratarÂ 
errosÂ deÂ autenticaÃ§Ã£o
axios.interceptors.response.
use(
Â Â (response)Â =>Â response,
Â Â (error)Â =>Â {
Â Â Â Â ifÂ (error.response?.
Â Â Â Â statusÂ ===Â 401)Â {
Â Â Â Â Â Â localStorage.removeItem
Â Â Â Â Â Â ('token');
Â Â Â Â Â Â window.location.hrefÂ =Â 
Â Â Â Â Â Â '/login';
Â Â Â Â }
Â Â Â Â returnÂ Promise.reject
Â Â Â Â (error);
Â Â }
);
```
### 2. Gerenciamento de Estado de AutenticaÃ§Ã£o
```
//Â ContextÂ ouÂ storeÂ paraÂ 
gerenciarÂ autenticaÃ§Ã£o
constÂ AuthContextÂ =Â {
Â Â user:Â null,
Â Â token:Â null,
Â Â isAdmin:Â false,
Â Â login:Â (credentials)Â =>Â {
Â Â Â Â //Â POSTÂ /api/auth/login
Â Â Â Â //Â SalvarÂ tokenÂ eÂ userÂ 
Â Â Â Â noÂ localStorage
Â Â Â Â //Â AtualizarÂ estado
Â Â },
Â Â logout:Â ()Â =>Â {
Â Â Â Â localStorage.removeItem
Â Â Â Â ('token');
Â Â Â Â localStorage.removeItem
Â Â Â Â ('user');
Â Â Â Â //Â RedirecionarÂ paraÂ 
Â Â Â Â login
Â Â }
};
```

### 3. Componente de PermissÃµes (ADMIN)
```
//Â TelaÂ paraÂ gerenciarÂ 
permissÃµesÂ deÂ usuÃ¡rio
constÂ UserPermissionsÂ =Â ({Â 
userIdÂ })Â =>Â {
Â Â constÂ [userDashboards,Â 
Â Â setUserDashboards]Â =Â 
Â Â useState([]);
Â Â constÂ 
Â Â [availableDashboards,Â 
Â Â setAvailableDashboards]Â =Â 
Â Â useState([]);
Â Â 
Â Â //Â CarregarÂ permissÃµesÂ 
Â Â atuaisÂ doÂ usuÃ¡rio
Â Â useEffect(()Â =>Â {
Â Â Â Â fetchUserDashboards
Â Â Â Â (userId);
Â Â Â Â fetchAvailableDashboards
Â Â Â Â ();
Â Â },Â [userId]);
Â Â 
Â Â constÂ grantAccessÂ =Â asyncÂ 
Â Â (dashboardId)Â =>Â {
Â Â Â Â awaitÂ axios.post('/api/
Â Â Â Â dashboard-permissions/
Â Â Â Â grant',Â {
Â Â Â Â Â Â userId,
Â Â Â Â Â Â dashboardId
Â Â Â Â });
Â Â Â Â //Â AtualizarÂ lista
Â Â };
Â Â 
Â Â constÂ revokeAccessÂ =Â asyncÂ 
Â Â (dashboardId)Â =>Â {
Â Â Â Â awaitÂ axios.post('/api/
Â Â Â Â dashboard-permissions/
Â Â Â Â revoke',Â {
Â Â Â Â Â Â userId,
Â Â Â Â Â Â dashboardId
Â Â Â Â });
Â Â Â Â //Â AtualizarÂ lista
Â Â };
};
```

### 4. ProteÃ§Ã£o de Rotas
```
//Â HOCÂ paraÂ protegerÂ rotasÂ 
queÂ precisamÂ deÂ admin
constÂ RequireAdminÂ =Â ({Â 
childrenÂ })Â =>Â {
Â Â constÂ {Â userÂ }Â =Â useAuth();
Â Â 
Â Â ifÂ (!userÂ ||Â user.roleÂ !==Â 
Â Â 'Admin')Â {
Â Â Â Â returnÂ <NavigateÂ to="/
Â Â Â Â unauthorized"Â />;
Â Â }
Â Â 
Â Â returnÂ children;
};

//Â Uso:
<RouteÂ path="/admin/
permissions"Â element={
Â Â <RequireAdmin>
Â Â Â Â <UserPermissionsÂ />
Â Â </RequireAdmin>
}Â />
```
## CORREÃ‡Ã•ES PARA ERROS ESPECÃFICOS
### Service Worker Cache Error
```
//Â DesabilitarÂ ouÂ corrigirÂ 
serviceÂ worker
//Â EmÂ index.jsÂ ouÂ App.js:
ifÂ ('serviceWorker'Â inÂ 
navigator)Â {
Â Â navigator.serviceWorker.
Â Â getRegistrations().then
Â Â (registrationsÂ =>Â {
Â Â Â Â registrations.forEach
Â Â Â Â (registrationÂ =>Â 
Â Â Â Â registration.unregister
Â Â Â Â ());
Â Â });
}
```

### Axios Error Handling
```
//Â MelhorÂ tratamentoÂ deÂ erros
constÂ apiCallÂ =Â asyncÂ ()Â =>Â {
Â Â tryÂ {
Â Â Â Â constÂ responseÂ =Â awaitÂ 
Â Â Â Â axios.get('/api/areas');
Â Â Â Â returnÂ response.data;
Â Â }Â catchÂ (error)Â {
Â Â Â Â ifÂ (error.response?.
Â Â Â Â statusÂ ===Â 403)Â {
Â Â Â Â Â Â console.error('AcessoÂ 
Â Â Â Â Â Â negadoÂ -Â verifiqueÂ 
Â Â Â Â Â Â permissÃµes');
Â Â Â Â }Â elseÂ ifÂ (error.
Â Â Â Â response?.statusÂ ===Â 
Â Â Â Â 401)Â {
Â Â Â Â Â Â console.error('TokenÂ 
Â Â Â Â Â Â invÃ¡lidoÂ -Â faÃ§aÂ loginÂ 
Â Â Â Â Â Â novamente');
Â Â Â Â }
Â Â Â Â throwÂ error;
Â Â }
};
```

### Frontend:
- Configurar interceptors do Axios
- Implementar gerenciamento de estado de auth
- Criar componente de permissÃµes para admin
- Adicionar proteÃ§Ã£o de rotas
- Tratar erros de autenticaÃ§Ã£o adequadamente
- Testar fluxo completo de login â†’ Ã¡reas â†’ permissÃµes

##  PONTOS DE ATENÃ‡ÃƒO
1. SeguranÃ§a : Sempre validar role no backend, nunca confiar apenas no frontend
2. Performance : Implementar cache inteligente para listas de Ã¡reas/dashboards
3. UX : Mostrar mensagens claras para erros de permissÃ£o
4. Logs : Implementar logging adequado para debug de permissÃµes

### CorreÃ§Ã£o NecessÃ¡ria:
```
//Â ObterÂ umaÂ ÃreaÂ porÂ IDÂ comÂ 
seusÂ DashboardsÂ (FiltradoÂ 
porÂ permissÃ£o)
exportÂ constÂ getAreaByIdÂ =Â 
asyncÂ (req,Â res)Â =>Â {
Â Â constÂ {Â idÂ }Â =Â req.params;
Â Â constÂ userÂ =Â req.user;
Â Â tryÂ {
Â Â Â Â constÂ areaIdÂ =Â parseInt
Â Â Â Â (id);
Â Â Â Â ifÂ (user.roleÂ !==Â 
Â Â Â Â "Admin")Â {
Â Â Â Â Â Â constÂ accessÂ =Â awaitÂ 
Â Â Â Â Â Â prisma.userAreaAccess.
Â Â Â Â Â Â findUnique({
Â Â Â Â Â Â Â Â where:Â {
Â Â Â Â Â Â Â Â Â Â userId_areaId:Â {
Â Â Â Â Â Â Â Â Â Â Â Â userId:Â user.
Â Â Â Â Â Â Â Â Â Â Â Â userId,
Â Â Â Â Â Â Â Â Â Â Â Â areaId:Â areaId,
Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â });
Â Â Â Â Â Â ifÂ (!access)Â {
Â Â Â Â Â Â Â Â returnÂ res.status
Â Â Â Â Â Â Â Â (403).json({Â error:Â 
Â Â Â Â Â Â Â Â "AcessoÂ negadoÂ aÂ 
Â Â Â Â Â Â Â Â estaÂ Ã¡rea."Â });
Â Â Â Â Â Â }
Â Â Â Â }

Â Â Â Â letÂ area;
Â Â Â Â ifÂ (user.roleÂ ===Â 
Â Â Â Â "Admin")Â {
Â Â Â Â Â Â //Â AdminÂ vÃªÂ todosÂ osÂ 
Â Â Â Â Â Â dashboards
Â Â Â Â Â Â areaÂ =Â awaitÂ prisma.
Â Â Â Â Â Â area.findUnique({
Â Â Â Â Â Â Â Â where:Â {Â id:Â 
Â Â Â Â Â Â Â Â areaIdÂ },
Â Â Â Â Â Â Â Â include:Â {
Â Â Â Â Â Â Â Â Â Â dashboards:Â true,
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â });
Â Â Â Â }Â elseÂ {
Â Â Â Â Â Â //Â UsuÃ¡rioÂ regular:Â 
Â Â Â Â Â Â filtrarÂ dashboardsÂ porÂ 
Â Â Â Â Â Â permissÃ£oÂ especÃ­fica
Â Â Â Â Â Â constÂ 
Â Â Â Â Â Â userDashboardAccessesÂ 
Â Â Â Â Â Â =Â awaitÂ prisma.
Â Â Â Â Â Â userDashboardAccess.
Â Â Â Â Â Â findMany({
Â Â Â Â Â Â Â Â where:Â {Â 
Â Â Â Â Â Â Â Â Â Â userId:Â user.
Â Â Â Â Â Â Â Â Â Â userId,
Â Â Â Â Â Â Â Â Â Â dashboard:Â {
Â Â Â Â Â Â Â Â Â Â Â Â areaId:Â areaId
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â include:Â {
Â Â Â Â Â Â Â Â Â Â dashboard:Â true
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â });

Â Â Â Â Â Â areaÂ =Â awaitÂ prisma.
Â Â Â Â Â Â area.findUnique({
Â Â Â Â Â Â Â Â where:Â {Â id:Â areaIdÂ }
Â Â Â Â Â Â });

Â Â Â Â Â Â ifÂ (area)Â {
Â Â Â Â Â Â Â Â //Â IncluirÂ apenasÂ 
Â Â Â Â Â Â Â Â dashboardsÂ comÂ 
Â Â Â Â Â Â Â Â permissÃ£oÂ especÃ­fica
Â Â Â Â Â Â Â Â area.dashboardsÂ =Â 
Â Â Â Â Â Â Â Â userDashboardAccesses
Â Â Â Â Â Â Â Â .map(accessÂ =>Â 
Â Â Â Â Â Â Â Â access.dashboard);
Â Â Â Â Â Â }
Â Â Â Â }

Â Â Â Â ifÂ (!area)Â {
Â Â Â Â Â Â returnÂ res.status(404).
Â Â Â Â Â Â json({Â error:Â "ÃreaÂ 
Â Â Â Â Â Â nÃ£oÂ encontrada."Â });
Â Â Â Â }
Â Â Â Â res.json(area);
Â Â }Â catchÂ (error)Â {
Â Â Â Â console.error("ErroÂ aoÂ 
Â Â Â Â buscarÂ Ã¡reaÂ porÂ IDÂ comÂ 
Â Â Â Â dashboards:",Â error);
Â Â Â Â res.status(500).json({Â 
Â Â Â Â error:Â "ErroÂ internoÂ doÂ 
Â Â Â Â servidorÂ aoÂ buscarÂ Ã¡rea.
Â Â Â Â "Â });
Â Â }
};
```